version: '3'

volumes:
  db-data:

services:
  phoenix:
    build: .
    volumes:
      - ./:/app
      - /Users/chazgoodare/mount/external/movies:/movies
      - /Users/chazgoodare/mount/external/shows:/shows
    ports:
      - "4000:4000"

  guessit:
    image: 'guessit/guessit-rest'
    ports:
      - "8080:80"

  postgresql:
    image: 'bitnami/postgresql:latest'
    volumes:
      - db-data:/bitnami/postgresql
    ports:
      - "5432:5432"
    environment:
      - POSTGRESQL_USERNAME=my_user
      - POSTGRESQL_PASSWORD=password123
      - POSTGRESQL_DATABASE=my_database
    
  postgresql-test:
    image: 'bitnami/postgresql:latest'
    environment:
      - POSTGRESQL_USERNAME=my_user
      - POSTGRESQL_PASSWORD=password123
      - POSTGRESQL_DATABASE=my_database

  test:
    build: .
    volumes:
       - ./:/app
       - ./samples/movies:/movies
       - ./samples/shows:/shows
    command: >
        bash -c "mix deps.get && mix ecto.create && mix test"